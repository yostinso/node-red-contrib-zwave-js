<script type="text/javascript">

    let Changed = false;

    RED.nodes.registerType('event-filter',
        {
            category: 'ZWave JS',
            color: 'rgb(46,145,205)',
            defaults:
            {
                name: { value: "ZWave Event Filter" },
                filters: {value:[{strict:false,index:0,name:"Catch-All",valueIds:[],events:["VALUE_UPDATED","VALUE_NOTIFICATION","NOTIFICATION","GET_VALUE_RESPONSE"]}]},
                outputs: {value: 1},
                changeDate: {value:undefined}
            },
            inputs: 1,
            outputs: 1,
            icon: "rbe.png",
            label: function () {
                return this.name;
            },
            oneditprepare: SortUI,
            oneditsave: DoSave,
            oneditcancel: function(){
                Changed = false;
            },
            outputLabels: function(index) {
                return this.filters[index].name
            }
        });

        
                

        function SortUI(){

            $("#filtersets").editableList({
                header: $('<div>').append('<div>Filter Sets - order defines outputs</div>'),
                sortable: true,
                removable: true, 
                addButton: 'Add Filter Set',
                addItem:AddItem
            });

            

            this.filters.forEach((Item) => {
                $("#filtersets").editableList('addItem',Item);
            });

        }
        
        function AddItem(container, index, data){
            if (Object.keys(data).length === 0) {
                    data.index = index;
                    data.name = "Filter Name"
                    data.valueIds = []
                    data.events = ["VALUE_UPDATED"]
                    data.strict = false
                }
            
            $(container).data('filter',data)
            $(container).click(SetActiveFilter);

            const HTML = `
            <table style="width:100%">
                <tr>
                    <td>Name</td>
                    <td><input class="data-name" value="${data.name}" type="text"></td>
                </tr>
                <tr>
                    <td>ValueIDs <span class="data-vid-count">${data.valueIds.length}</span> </td>
                    <td><input class="data-valueid-editor" value="" type="text"></td>
                </tr>
                <tr>
                    <td>Strict (Match Endpoint)</td>
                    <td><input class="data-event-Endpoint" type="checkbox"></td>
                </tr>
                <tr>
                    <td>Events</td>
                    <td>
                        <input class="data-event-VALUE_UPDATED" type="checkbox"> VALUE_UPDATED<br />
                        <input class="data-event-VALUE_NOTIFICATION" type="checkbox"> VALUE_NOTIFICATION<br />
                        <input class="data-event-NOTIFICATION" type="checkbox"> NOTIFICATION<br />
                        <input class="data-event-GET_VALUE_RESPONSE" type="checkbox"> GET_VALUE_RESPONSE
                    </td>
                </tr>
            
            `; 

            $(container).html(HTML);

            const Refresh = $('<button>')
                .addClass('ui-button')
                .addClass('ui-corner-all')
                .addClass('ui-widget')
                .addClass('rightButton')
                .html('&#8635;')
                .click(()=>{
                    SyncEdits()
                })
                .insertAfter($(container).find('.data-valueid-editor'))
            $(container).find('.data-valueid-editor').typedInput({types: ["json"],default: "json"});
            $(container).find('.data-valueid-editor').typedInput('value',JSON.stringify(data.valueIds));

            
            SortChecbox($(container))

     
        }

        
        let ActiveFilter;

        function SyncEdits(){


            const JSONs = ActiveFilter.find('.data-valueid-editor').typedInput('value');
            const NewObject = JSON.parse(JSONs);

            ActiveFilter.data('filter').valueIds = NewObject
            const Count = NewObject.length;
            ActiveFilter.find(".data-vid-count").html(Count);

            Changed = true;

            
        }


        function SetActiveFilter(){


            const Items = $("#filtersets").editableList('items');
            for(let i = 0;i<Items.length;i++){
                Items[i].css({backgroundColor:'white'});
            }
            $(this).css({backgroundColor:'lightgray'});

            ActiveFilter = $(this);
        }

        function SortChecbox(El){

            const Data = El.data('filter');
            Data.events.forEach((EV) =>{
                El.find(".data-event-"+EV).prop('checked',true);
            })

            if(Data.strict){
                El.find(".data-event-Endpoint").prop('checked',true);
            }
        }

        function DoSave(){

            if(Changed){
                this.changeDate = new Date();
                Changed = false
            }

            this.outputs = $("#filtersets").editableList('length')
            const Items = $("#filtersets").editableList('items')
            const Events = ["VALUE_UPDATED","VALUE_NOTIFICATION","NOTIFICATION","GET_VALUE_RESPONSE"]
            this.filters = [];

            for(let i = 0;i<Items.length;i++){

                const El = $(Items[i])
                const ItemData = Items[i].data('filter');

                ItemData.events = []
                Events.forEach((EV) =>{

                    if(El.find(".data-event-"+EV).prop('checked')){
                        ItemData.events.push(EV)
                    }
                })

                ItemData.index = i;
                ItemData.name = El.find(".data-name").val();
                ItemData.strict = El.find(".data-event-Endpoint").prop('checked');
                this.filters.push(ItemData);
            }
        }

        function AddValueIDToFilter(ValueID){

            const VIDs = ActiveFilter.data('filter').valueIds;

            VIDs.push(ValueID);
            const Count = VIDs.length

            ActiveFilter.find(".data-vid-count").html(Count);
            ActiveFilter.find('.data-valueid-editor').typedInput('value',JSON.stringify(VIDs));

            Changed = true;
            
        }

      

</script>

<script type="text/x-red" data-template-name="event-filter">

  
   

    <div class="form-row">
        <label for="node-input-name" style="width:130px"><i class="fa fa-pencil"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Filter Name">
    </div>

    <p>
        Add your filter sets below.<br />
        each set of filters, becomes an output pin.<br /><br />
        A filter set can include the event(s) to be filtered, and optionally ValueID(s)
    </p>
    
    <div>
        <ol id="filtersets" style="min-height:450px;min-width:400px"> </ol>
    </div>

   
    
   
   
   
    
   
</script>

<script type="text/x-red" data-help-name="event-filter">
    <p>A Z-Wave event filter.</p>

 
</script>
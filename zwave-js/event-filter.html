<script type="text/javascript">

    RED.nodes.registerType('event-filter',
        {
            category: 'ZWave JS',
            color: 'rgb(46,145,205)',
            defaults:
            {
                name: { value: "ZWave Event Filter" },
                filters: {value:[]},
                outputs: {value: 0}
            },
            inputs: 1,
            outputs: 0,
            icon: "rbe.png",
            label: function () {
                return this.name;
            },
            oneditprepare: SortUI,
            oneditsave:DoSave,
            outputLabels: function(index) {
                return this.filters[index].name
            }
        });

        function SortUI(){

            $("#filtersets").editableList({
                header: $('<div>').append('<div>Filter Sets - order defines outputs</div>'),
                sortable: true,
                removable: true, 
                addButton: 'Add Filter Set',
                addItem:AddItem
            });

            this.filters.forEach((Item) => {
                $("#filtersets").editableList('addItem',Item);
            });

        }
        
        function AddItem(container, index, data){
            if (Object.keys(data).length === 0) {
                    data.index = index;
                    data.name = "Filter Name"
                    data.valueIds = []
                    data.events = ["VALUE_UPDATED"]
                }
            
            $(container).data('filter',data)
            $(container).html('<strong>Name:</strong> <input class="data-name" value="'+data.name+'" type="text"><br /><strong>ValueIDs:</strong> <span class="data-vids">"'+data.valueIds.length+'</span><br /><strong>Events:</strong><br /><input class="data-event-VALUE_UPDATED" type="checkbox"> VALUE_UPDATED<br /><input class="data-event-VALUE_NOTIFICATION" type="checkbox"> VALUE_NOTIFICATION<br /><input class="data-event-NOTIFICATION" type="checkbox"> NOTIFICATION<br /><input class="data-event-GET_VALUE_RESPONSE" type="checkbox"> GET_VALUE_RESPONSE');
            SortChecbox($(container))
        }

        function SortChecbox(El){

            const Data = El.data('filter');
            Data.events.forEach((EV) =>{
                El.find(".data-event-"+EV).prop('checked',true);
            })
        }

        function DoSave(){

            this.outputs = $("#filtersets").editableList('length')
            const Items = $("#filtersets").editableList('items')
            const Events = ["VALUE_UPDATED","VALUE_NOTIFICATION","NOTIFICATION","GET_VALUE_RESPONSE"]
            this.filters = [];

            for(let i = 0;i<Items.length;i++){

                const El = $(Items[i])
                const ItemData = Items[i].data('filter');

                ItemData.events = []
                Events.forEach((EV) =>{

                    if(El.find(".data-event-"+EV).prop('checked')){
                        ItemData.events.push(EV)
                    }
                })
                
                ItemData.index = i;
                ItemData.name = El.find(".data-name").val();
                this.filters.push(ItemData);
            }
        }

        function AddValueIDToFilter(ValueID){
            
        }

      

</script>

<script type="text/x-red" data-template-name="event-filter">

  
    <p>
        Add your filter sets below.<br />
        each set of filters, becomes an output pin.<br /><br />
        A filter set can include the event(s) to be filtered, and optionally ValueID(s)
    </p>

  
<div>
   <ol id="filtersets" style="min-height:450px;min-width:400px">
   </ol>
</div>

   
    
   
   
   
    
   
</script>

<script type="text/x-red" data-help-name="event-filter">
    <p>A Z-Wave event filter.</p>

 
</script>